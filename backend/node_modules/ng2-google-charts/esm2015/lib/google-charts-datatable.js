import { __decorate, __metadata } from "tslib";
import { EventEmitter, Output, } from '@angular/core';
export class GoogleChartsDataTable {
    constructor(opt) {
        this.opt = opt;
        this.dataTableChanged = new EventEmitter();
        if (opt) {
            this._setDataTable(opt.dataTable, opt.firstRowIsData);
        }
    }
    send() {
        if (this.query === undefined) {
            return;
        }
        this.query.send((queryResponse) => {
            this.setDataTable(queryResponse.getDataTable());
            if (this.opt.queryCallback) {
                this.opt.queryCallback(queryResponse);
            }
        });
    }
    init(opt) {
        if (opt) {
            this.opt = opt;
        }
        if (this.tid !== undefined) {
            // doesn't work, see https://github.com/google/google-visualization-issues/issues/2381
            // this.query.abort();
            window.clearInterval(this.tid);
            this.tid = undefined;
        }
        if (this.opt.dataSourceUrl) {
            this.query = new google.visualization.Query(this.opt.dataSourceUrl);
            if (this.opt.query) {
                this.query.setQuery(this.opt.query);
            }
            if (this.opt.timeout !== undefined) {
                this.query.setTimeout(this.opt.timeout);
            }
            if (this.opt.refreshInterval) {
                // this.query.setRefreshInterval(this.opt.refreshInterval);
                this.tid = window.setInterval(() => {
                    this.send();
                }, this.opt.refreshInterval * 1000);
            }
            this.send();
        }
        else {
            this.setDataTable(this.opt.dataTable);
        }
    }
    /**
     * @returns Underlying google.visualization.DataTable
     */
    getDataTable() {
        return this.dataTable;
    }
    setDataTable(dt, firstRowIsData) {
        if (firstRowIsData === undefined) {
            firstRowIsData = this.opt.firstRowIsData;
        }
        this._setDataTable(dt, firstRowIsData);
        this.dataTableChanged.emit(this.dataTable);
    }
    _setDataTable(dt, firstRowIsData) {
        if (Array.isArray(dt)) {
            dt = google.visualization.arrayToDataTable(dt, firstRowIsData);
        }
        this.dataTable = dt;
        this.reformat();
    }
    /**
     * Applies formatters to data columns, if defined
     */
    reformat() {
        const dt = this.dataTable;
        if (dt === undefined) {
            return;
        }
        if (this.opt.formatters === undefined) {
            return;
        }
        for (const formatterConfig of this.opt.formatters) {
            let formatter;
            if (formatterConfig.type === 'PatternFormat') {
                const fmtOptions = formatterConfig.options;
                formatter = new google.visualization.PatternFormat(fmtOptions.pattern);
                formatter.format(dt, formatterConfig.columns, fmtOptions.dstColumnIndex);
                continue;
            }
            const formatterConstructor = google.visualization[formatterConfig.type];
            const formatterOptions = formatterConfig.options;
            formatter = new formatterConstructor(formatterOptions);
            if (formatterConfig.type === 'ColorFormat' && formatterOptions) {
                const fmtOptions = formatterOptions;
                for (const range of fmtOptions.ranges) {
                    if (typeof (range.fromBgColor) !== 'undefined'
                        && typeof (range.toBgColor) !== 'undefined') {
                        formatter.addGradientRange(range.from, range.to, range.color, range.fromBgColor, range.toBgColor);
                    }
                    else {
                        formatter.addRange(range.from, range.to, range.color, range.bgcolor);
                    }
                }
            }
            for (const col of formatterConfig.columns) {
                formatter.format(dt, col);
            }
        }
    }
}
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartsDataTable.prototype, "dataTableChanged", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0cy1kYXRhdGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZzItZ29vZ2xlLWNoYXJ0cy9zcmMvbGliL2dvb2dsZS1jaGFydHMtZGF0YXRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFzRkEsT0FBTyxFQUNMLFlBQVksRUFDWixNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFFdkIsTUFBTSxPQUFPLHFCQUFxQjtJQU9oQyxZQUFvQixHQUFtQztRQUFuQyxRQUFHLEdBQUgsR0FBRyxDQUFnQztRQUY3QyxxQkFBZ0IsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUdqRSxJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7U0FDdkQ7SUFDSCxDQUFDO0lBRU8sSUFBSTtRQUNWLElBQUksSUFBSSxDQUFDLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDNUIsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFrQixFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQzthQUN2QztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLElBQUksQ0FBQyxHQUFvQztRQUM5QyxJQUFJLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1NBQ2hCO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLFNBQVMsRUFBRTtZQUMxQixzRkFBc0Y7WUFDdEYsc0JBQXNCO1lB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WyJkZWNsYXJlIHZhciBnb29nbGU6IGFueTtcblxuZXhwb3J0IGludGVyZmFjZSBBcnJvd0Zvcm1hdEludGVyZmFjZSB7XG4gIGJhc2U6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCYXJGb3JtYXRJbnRlcmZhY2Uge1xuICBiYXNlPzogbnVtYmVyO1xuICBjb2xvck5lZ2F0aXZlPzogc3RyaW5nO1xuICBjb2xvclBvc2l0aXZlPzogc3RyaW5nO1xuICBkcmF3WmVyb0xpbmU/OiBib29sZWFuO1xuICBtYXg/OiBudW1iZXI7XG4gIG1pbj86IG51bWJlcjtcbiAgc2hvd1ZhbHVlPzogYm9vbGVhbjtcbiAgd2lkdGg/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmFuZ2VJbnRlcmZhY2Uge1xuICBmcm9tOiBudW1iZXIgfCBEYXRlIHwgbnVtYmVyW107XG4gIHRvOiBudW1iZXIgfCBEYXRlIHwgbnVtYmVyW107XG4gIGNvbG9yPzogc3RyaW5nO1xuICBiZ2NvbG9yPzogc3RyaW5nO1xuICBmcm9tQmdDb2xvcj86IHN0cmluZztcbiAgdG9CZ0NvbG9yPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbG9yRm9ybWF0SW50ZXJmYWNlIHtcbiAgcmFuZ2VzPzogUmFuZ2VJbnRlcmZhY2VbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEYXRlRm9ybWF0IHtcbiAgZm9ybWF0VHlwZT86IHN0cmluZztcbiAgcGF0dGVybj86IHN0cmluZztcbiAgdGltZVpvbmU/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTnVtYmVyRm9ybWF0SW50ZXJmYWNlIHtcbiAgZGVjaW1hbFN5bWJvbD86IHN0cmluZztcbiAgZnJhY3Rpb25EaWdpdHM/OiBudW1iZXI7XG4gIGdyb3VwaW5nU3ltYm9sPzogc3RyaW5nO1xuICBuZWdhdGl2ZUNvbG9yPzogc3RyaW5nO1xuICBuZWdhdGl2ZVBhcmVucz86IGJvb2xlYW47XG4gIHBhdHRlcm4/OiBzdHJpbmc7XG4gIHByZWZpeD86IHN0cmluZztcbiAgc3VmZml4Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBhdHRlcm5Gb3JtYXRJbnRlcmZhY2Uge1xuICBwYXR0ZXJuOiBzdHJpbmc7XG4gIGRzdENvbHVtbkluZGV4PzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZvcm1hdHRlckludGVyZmFjZSB7XG4gIHR5cGU6IHN0cmluZztcbiAgb3B0aW9ucz86IChcbiAgICBBcnJvd0Zvcm1hdEludGVyZmFjZVxuICAgIHwgQmFyRm9ybWF0SW50ZXJmYWNlXG4gICAgfCBDb2xvckZvcm1hdEludGVyZmFjZVxuICAgIHwgRGF0ZUZvcm1hdFxuICAgIHwgTnVtYmVyRm9ybWF0SW50ZXJmYWNlXG4gICAgfCBQYXR0ZXJuRm9ybWF0SW50ZXJmYWNlXG4gICk7XG4gIGNvbHVtbnM6IG51bWJlcltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdvb2dsZUNoYXJ0c0RhdGFUYWJsZUludGVyZmFjZSB7XG4gIGRhdGFUYWJsZT86IGFueTtcbiAgZmlyc3RSb3dJc0RhdGE/OiBib29sZWFuO1xuICBxdWVyeT86IHN0cmluZztcbiAgZGF0YVNvdXJjZVVybD86IHN0cmluZztcblxuICAvKiogUmVmcmVzaCBpbnRlcnZhbCwgaW4gc2Vjb25kcywgd2hlbiB1c2luZyByZW1vdGUgZGF0YSBzb3VyY2UuICovXG4gIHJlZnJlc2hJbnRlcnZhbD86IG51bWJlcjtcblxuICAvKiogVGltZW91dCBpbiBzZWNvbmRzLCB3aGVuIHVzaW5nIHJlbW90ZSBkYXRhIHNvdXJjZSAqL1xuICB0aW1lb3V0PzogbnVtYmVyO1xuXG4gIC8qKiBDYWxsZWQgYWZ0ZXIgcXVlcnkgZXhlY3V0ZWQuIERhdGFUYWJsZSBpcyB1cGRhdGVkIGF1dG9tYXRpY2FsbHkuXG4gICAqIEBwYXJhbSBxdWVyeVJlc3BvbnNlIGdvb2dsZS52aXN1YWxpemF0aW9uLlF1ZXJ5UmVzcG9uc2VcbiAgICovXG4gIHF1ZXJ5Q2FsbGJhY2s/OiAocXVlcnlSZXNwb25zZTogYW55KSA9PiBhbnk7XG5cbiAgZm9ybWF0dGVycz86IEZvcm1hdHRlckludGVyZmFjZVtdO1xuICB2aWV3Pzogc3RyaW5nIHwgb2JqZWN0IHwgb2JqZWN0W107XG59XG5cbmltcG9ydCB7XG4gIEV2ZW50RW1pdHRlcixcbiAgT3V0cHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuZXhwb3J0IGNsYXNzIEdvb2dsZUNoYXJ0c0RhdGFUYWJsZSB7XG4gIHByaXZhdGUgZGF0YVRhYmxlOiBhbnk7XG4gIHB1YmxpYyBxdWVyeTogYW55O1xuICBwdWJsaWMgdGlkOiBhbnk7XG5cbiAgQE91dHB1dCgpIGRhdGFUYWJsZUNoYW5nZWQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0OiBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2UpIHtcbiAgICBpZiAob3B0KSB7XG4gICAgICB0aGlzLl9zZXREYXRhVGFibGUob3B0LmRhdGFUYWJsZSwgb3B0LmZpcnN0Um93SXNEYXRhKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbmQoKSB7XG4gICAgaWYgKHRoaXMucXVlcnkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnF1ZXJ5LnNlbmQoKHF1ZXJ5UmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgdGhpcy5zZXREYXRhVGFibGUocXVlcnlSZXNwb25zZS5nZXREYXRhVGFibGUoKSk7XG4gICAgICBpZiAodGhpcy5vcHQucXVlcnlDYWxsYmFjaykge1xuICAgICAgICB0aGlzLm9wdC5xdWVyeUNhbGxiYWNrKHF1ZXJ5UmVzcG9uc2UpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGluaXQob3B0PzogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlSW50ZXJmYWNlKSB7XG4gICAgaWYgKG9wdCkge1xuICAgICAgdGhpcy5vcHQgPSBvcHQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudGlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIGRvZXNuJ3Qgd29yaywgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9nb29nbGUvZ29vZ2xlLXZpc3VhbGl6YXRpb24taXNzdWVzL2lzc3Vlcy8yMzgxXG4gICAgICAvLyB0aGlzLnF1ZXJ5LmFib3J0KCk7XG4gICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aGlzLnRpZCk7XG4gICAgICB0aGlzLnRpZCA9IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHQuZGF0YVNvdXJjZVVybCkge1xuICAgICAgdGhpcy5xdWVyeSA9IG5ldyBnb29nbGUudmlzdWFsaXphdGlvbi5RdWVyeSh0aGlzLm9wdC5kYXRhU291cmNlVXJsKTtcbiAgICAgIGlmICh0aGlzLm9wdC5xdWVyeSkge1xuICAgICAgICB0aGlzLnF1ZXJ5LnNldFF1ZXJ5KHRoaXMub3B0LnF1ZXJ5KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm9wdC50aW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5xdWVyeS5zZXRUaW1lb3V0KHRoaXMub3B0LnRpbWVvdXQpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMub3B0LnJlZnJlc2hJbnRlcnZhbCkge1xuICAgICAgICAvLyB0aGlzLnF1ZXJ5LnNldFJlZnJlc2hJbnRlcnZhbCh0aGlzLm9wdC5yZWZyZXNoSW50ZXJ2YWwpO1xuICAgICAgICB0aGlzLnRpZCA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZW5kKCk7XG4gICAgICAgIH0sIHRoaXMub3B0LnJlZnJlc2hJbnRlcnZhbCAqIDEwMDApO1xuICAgICAgfVxuICAgICAgdGhpcy5zZW5kKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0RGF0YVRhYmxlKHRoaXMub3B0LmRhdGFUYWJsZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIFVuZGVybHlpbmcgZ29vZ2xlLnZpc3VhbGl6YXRpb24uRGF0YVRhYmxlXG4gICAqL1xuXG4gIHB1YmxpYyBnZXREYXRhVGFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YVRhYmxlO1xuICB9XG5cbiAgcHVibGljIHNldERhdGFUYWJsZShkdDogYW55LCBmaXJzdFJvd0lzRGF0YT86IGJvb2xlYW4pIHtcbiAgICBpZiAoZmlyc3RSb3dJc0RhdGEgPT09IHVuZGVmaW5lZCkge1xuICAgICAgZmlyc3RSb3dJc0RhdGEgPSB0aGlzLm9wdC5maXJzdFJvd0lzRGF0YTtcbiAgICB9XG4gICAgdGhpcy5fc2V0RGF0YVRhYmxlKGR0LCBmaXJzdFJvd0lzRGF0YSk7XG4gICAgdGhpcy5kYXRhVGFibGVDaGFuZ2VkLmVtaXQodGhpcy5kYXRhVGFibGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0RGF0YVRhYmxlKGR0OiBhbnksIGZpcnN0Um93SXNEYXRhPzogYm9vbGVhbikge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGR0KSkge1xuICAgICAgZHQgPSBnb29nbGUudmlzdWFsaXphdGlvbi5hcnJheVRvRGF0YVRhYmxlKGR0LCBmaXJzdFJvd0lzRGF0YSk7XG4gICAgfVxuICAgIHRoaXMuZGF0YVRhYmxlID0gZHQ7XG4gICAgdGhpcy5yZWZvcm1hdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFwcGxpZXMgZm9ybWF0dGVycyB0byBkYXRhIGNvbHVtbnMsIGlmIGRlZmluZWRcbiAgICovXG5cbiAgcHVibGljIHJlZm9ybWF0KCkge1xuICAgIGNvbnN0IGR0ID0gdGhpcy5kYXRhVGFibGU7XG4gICAgaWYgKGR0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5vcHQuZm9ybWF0dGVycyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBmb3JtYXR0ZXJDb25maWcgb2YgdGhpcy5vcHQuZm9ybWF0dGVycykge1xuICAgICAgbGV0IGZvcm1hdHRlcjogYW55O1xuICAgICAgaWYgKGZvcm1hdHRlckNvbmZpZy50eXBlID09PSAnUGF0dGVybkZvcm1hdCcpIHtcbiAgICAgICAgY29uc3QgZm10T3B0aW9ucyA9IGZvcm1hdHRlckNvbmZpZy5vcHRpb25zIGFzIFBhdHRlcm5Gb3JtYXRJbnRlcmZhY2U7XG4gICAgICAgIGZvcm1hdHRlciA9IG5ldyBnb29nbGUudmlzdWFsaXphdGlvbi5QYXR0ZXJuRm9ybWF0KGZtdE9wdGlvbnMucGF0dGVybik7XG4gICAgICAgIGZvcm1hdHRlci5mb3JtYXQoZHQsIGZvcm1hdHRlckNvbmZpZy5jb2x1bW5zLCBmbXRPcHRpb25zLmRzdENvbHVtbkluZGV4KTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZvcm1hdHRlckNvbnN0cnVjdG9yID0gZ29vZ2xlLnZpc3VhbGl6YXRpb25bZm9ybWF0dGVyQ29uZmlnLnR5cGVdO1xuICAgICAgY29uc3QgZm9ybWF0dGVyT3B0aW9ucyA9IGZvcm1hdHRlckNvbmZpZy5vcHRpb25zO1xuICAgICAgZm9ybWF0dGVyID0gbmV3IGZvcm1hdHRlckNvbnN0cnVjdG9yKGZvcm1hdHRlck9wdGlvbnMpO1xuICAgICAgaWYgKGZvcm1hdHRlckNvbmZpZy50eXBlID09PSAnQ29sb3JGb3JtYXQnICYmIGZvcm1hdHRlck9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgZm10T3B0aW9ucyA9IGZvcm1hdHRlck9wdGlvbnMgYXMgQ29sb3JGb3JtYXRJbnRlcmZhY2U7XG4gICAgICAgIGZvciAoY29uc3QgcmFuZ2Ugb2YgZm10T3B0aW9ucy5yYW5nZXMpIHtcbiAgICAgICAgICBpZiAodHlwZW9mIChyYW5nZS5mcm9tQmdDb2xvcikgIT09ICd1bmRlZmluZWQnXG4gICAgICAgICAgICAgICYmIHR5cGVvZiAocmFuZ2UudG9CZ0NvbG9yKSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGZvcm1hdHRlci5hZGRHcmFkaWVudFJhbmdlKHJhbmdlLmZyb20sIHJhbmdlLnRvLFxuICAgICAgICAgICAgICByYW5nZS5jb2xvciwgcmFuZ2UuZnJvbUJnQ29sb3IsIHJhbmdlLnRvQmdDb2xvcik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvcm1hdHRlci5hZGRSYW5nZShyYW5nZS5mcm9tLCByYW5nZS50bywgcmFuZ2UuY29sb3IsIHJhbmdlLmJnY29sb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBmb3IgKGNvbnN0IGNvbCBvZiBmb3JtYXR0ZXJDb25maWcuY29sdW1ucykge1xuICAgICAgICBmb3JtYXR0ZXIuZm9ybWF0KGR0LCBjb2wpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19